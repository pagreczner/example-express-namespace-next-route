
/**
 * Module dependencies.
 */

var express = require('express')
  , methods = require('methods').concat('del')
  , apps = express.application
    ? [express.application]
    : [express.HTTPServer.prototype, express.HTTPSServer.prototype];


// Declare a global lookup hash for namespace wildcards.
var NS_STAR_HASH = {};

/**
 * Namespace using the given `path`, providing a callback `fn()`,
 * which will be invoked immediately, resetting the namespace to the previous.
 *
 * @param {String} path
 * @param {Function} fn
 * @return {Server} for chaining
 * @api public
 */
 var namespace = exports.namespace = function(){
  var args = Array.prototype.slice.call(arguments)
    , path = args.shift()
    , fn = args.pop()
    , self = this;
  
  // Definse for every type of all, the middleware function
  if (args.length) self.all(path, args);
  
  // Definse for every type of namespace/* the middleware
  if (args.length) {
    // Don't apply the wildcard this time.
    //self.all(path + '/*', args);
    
    // Set the arg lookup for the wildcard route
    NS_STAR_HASH[path] = args;
  }
  
  (this._ns = this._ns || []).push(path);

  fn.call(this);
  this._ns.pop();
  return this;
};

apps.forEach(function(app){
  app.namespace = namespace;
});

/**
 * Proxy HTTP methods to provide namespacing support.
 */

methods.forEach(function(method){
  apps.forEach(function(app){
    var orig = app[method];
    
    app[method] = function(val){
      var len = arguments.length;
      if ('get' == method && 1 == len) return orig.call(this, val);

      var args = Array.prototype.slice.call(arguments)
        , path = args.shift()
        , self = this;

      this.namespace(path, function(){
        // Loop over all the namespaces in reverse order. When you find
        // a namespace that is in the namespace lookup hash, then prepend
        // all the middleware to the current arguments.
        for(var nsIndex = this._ns.length-1; nsIndex >= 0; nsIndex -= 1) {
          var currNs = this._ns[nsIndex];
          if(NS_STAR_HASH[currNs] != undefined){
            args = NS_STAR_HASH[currNs].concat(args);
          }
        }
        
        path = this._ns.join('/').replace(/\/\//g, '/').replace(/\/$/, '') || '/';
        args.unshift(path);
        orig.apply(self, args);
      });

      return this;
    };
  });
});